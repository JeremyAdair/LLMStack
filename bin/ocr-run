#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "Usage: bin/ocr-run <filename>" >&2
  exit 1
fi

repo_root=$(git rev-parse --show-toplevel)
input_name="$1"
input_path="${repo_root}/workspace/ocr/in/${input_name}"
output_base="${repo_root}/workspace/ocr/out/${input_name%.*}"

if [[ ! -f "$input_path" ]]; then
  echo "Input file not found: $input_path" >&2
  exit 1
fi

mkdir -p "${repo_root}/workspace/ocr/out"

compose_files=(
  "${repo_root}/compose/docker-compose.yml"
  "${repo_root}/compose/ocr/docker-compose.yml"
)

args=()
for file in "${compose_files[@]}"; do
  args+=("-f" "$file")
done

docker compose "${args[@]}" run --rm ocr \
  tesseract "/workspace/ocr/in/${input_name}" "/workspace/ocr/out/${input_name%.*}"

echo "OCR output written to ${output_base}.txt"
