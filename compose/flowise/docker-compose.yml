services:
  flowise:
    image: flowiseai/flowise:latest
    environment:
      # Flowise talks to Ollama over the internal network.
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
      # Optional basic auth credentials.
      FLOWISE_USERNAME: ${FLOWISE_USERNAME:-}
      FLOWISE_PASSWORD: ${FLOWISE_PASSWORD:-}
      # Serve Flowise under a path on the reverse proxy.
      FLOWISE_BASE_PATH: ${FLOWISE_BASE_PATH:-/}
    volumes:
      # Persist Flowise configuration and data.
      - flowise_data:/root/.flowise
      # Host bind mount for drop-in PDFs on Windows.
      - type: bind
        source: "C:\\llm-stack\\pdfs"
        target: /data/pdfs
    networks:
      - llm-stack
    depends_on:
      - ollama
    expose:
      # Internal-only port; reverse proxy publishes it.
      - "3000"

  pdf-auto-ingest:
    image: alpine:3.20
    environment:
      FLOWISE_URL: ${FLOWISE_URL:-http://flowise:3000}
      FLOWISE_INGEST_CHATFLOW_ID: ${FLOWISE_INGEST_CHATFLOW_ID:-f2f4fce2-9c7d-4ca6-8fd7-6c4b0c97f111}
      FLOWISE_INGEST_STOP_NODE_ID: ${FLOWISE_INGEST_STOP_NODE_ID:-qdrant_0}
      PDF_WATCH_DIR: /data/pdfs
    volumes:
      - type: bind
        source: "C:\\llm-stack\\pdfs"
        target: /data/pdfs
      - ./flowise/scripts:/scripts:ro
    command:
      - /bin/sh
      - /scripts/pdf-auto-ingest.sh
    networks:
      - llm-stack
    depends_on:
      - flowise
